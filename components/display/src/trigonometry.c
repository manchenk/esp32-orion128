/*
 * This file is part of the display interface distribution
 * (https://gitlab.romanchenko.su/esp/components/display.git).
 * Copyright (c) 2022 Dmitry Romanchenko.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, version 3.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
#include "trigonometry.h"

static const uint16_t __attribute__((unused)) display_cos_table[257] = {
    0x8000, 0x8000, 0x7FFF, 0x7FFD, 0x7FFB, 0x7FF8, 0x7FF5, 0x7FF1,
    0x7FEC, 0x7FE7, 0x7FE1, 0x7FDB, 0x7FD4, 0x7FCC, 0x7FC4, 0x7FBB,
    0x7FB1, 0x7FA7, 0x7F9C, 0x7F91, 0x7F85, 0x7F78, 0x7F6B, 0x7F5D,
    0x7F4F, 0x7F40, 0x7F30, 0x7F20, 0x7F0F, 0x7EFD, 0x7EEB, 0x7ED8,
    0x7EC5, 0x7EB1, 0x7E9D, 0x7E88, 0x7E72, 0x7E5C, 0x7E45, 0x7E2D,
    0x7E15, 0x7DFC, 0x7DE3, 0x7DC9, 0x7DAF, 0x7D93, 0x7D78, 0x7D5B,
    0x7D3F, 0x7D21, 0x7D03, 0x7CE4, 0x7CC5, 0x7CA5, 0x7C85, 0x7C64,
    0x7C42, 0x7C20, 0x7BFD, 0x7BDA, 0x7BB6, 0x7B92, 0x7B6D, 0x7B47,
    0x7B21, 0x7AFA, 0x7AD3, 0x7AAB, 0x7A82, 0x7A59, 0x7A30, 0x7A06,
    0x79DB, 0x79B0, 0x7984, 0x7958, 0x792B, 0x78FD, 0x78CF, 0x78A1,
    0x7871, 0x7842, 0x7812, 0x77E1, 0x77B0, 0x777E, 0x774B, 0x7718,
    0x76E5, 0x76B1, 0x767D, 0x7648, 0x7612, 0x75DC, 0x75A5, 0x756E,
    0x7537, 0x74FF, 0x74C6, 0x748D, 0x7453, 0x7419, 0x73DF, 0x73A3,
    0x7368, 0x732C, 0x72EF, 0x72B2, 0x7274, 0x7236, 0x71F8, 0x71B9,
    0x7179, 0x7139, 0x70F9, 0x70B8, 0x7076, 0x7034, 0x6FF2, 0x6FAF,
    0x6F6C, 0x6F28, 0x6EE4, 0x6E9F, 0x6E5A, 0x6E15, 0x6DCF, 0x6D88,
    0x6D41, 0x6CFA, 0x6CB2, 0x6C6A, 0x6C21, 0x6BD8, 0x6B8F, 0x6B45,
    0x6AFB, 0x6AB0, 0x6A65, 0x6A1A, 0x69CE, 0x6981, 0x6935, 0x68E7,
    0x689A, 0x684C, 0x67FE, 0x67AF, 0x6760, 0x6711, 0x66C1, 0x6671,
    0x6620, 0x65CF, 0x657E, 0x652C, 0x64DA, 0x6488, 0x6435, 0x63E2,
    0x638E, 0x633B, 0x62E7, 0x6292, 0x623D, 0x61E8, 0x6193, 0x613D,
    0x60E7, 0x6091, 0x603A, 0x5FE3, 0x5F8C, 0x5F34, 0x5EDC, 0x5E84,
    0x5E2B, 0x5DD3, 0x5D79, 0x5D20, 0x5CC6, 0x5C6C, 0x5C12, 0x5BB8,
    0x5B5D, 0x5B02, 0x5AA7, 0x5A4B, 0x59EF, 0x5993, 0x5937, 0x58DB,
    0x587E, 0x5821, 0x57C4, 0x5766, 0x5709, 0x56AB, 0x564C, 0x55EE,
    0x5590, 0x5531, 0x54D2, 0x5473, 0x5413, 0x53B4, 0x5354, 0x52F4,
    0x5294, 0x5234, 0x51D3, 0x5173, 0x5112, 0x50B1, 0x5050, 0x4FEE,
    0x4F8D, 0x4F2B, 0x4ECA, 0x4E68, 0x4E06, 0x4DA4, 0x4D41, 0x4CDF,
    0x4C7C, 0x4C1A, 0x4BB7, 0x4B54, 0x4AF1, 0x4A8E, 0x4A2B, 0x49C7,
    0x4964, 0x4901, 0x489D, 0x4839, 0x47D6, 0x4772, 0x470E, 0x46AA,
    0x4646, 0x45E2, 0x457E, 0x451A, 0x44B5, 0x4451, 0x43ED, 0x4388,
    0x4324, 0x42C0, 0x425B, 0x41F7, 0x4192, 0x412E, 0x40C9, 0x4065,
    0x4000
};

uint16_t display_cos(uint16_t angle)
{
    angle &= 0x3ff;
    uint16_t quart = angle >> 8;
    uint16_t index = angle & 0xff;
    switch (quart) {
        case 0: return display_cos_table[index];
        case 1: return 0x8000 - display_cos_table[256 - index];
        case 2: return 0x8000 - display_cos_table[index];
        case 3: return display_cos_table[256 - index];
    }
    return 0;
}

uint16_t display_sin(uint16_t angle)
{
    angle += 0x100;
    angle &= 0x3ff;
    return display_cos(angle);
}

#define DISPLAY_MUL(a,b) (((a)*(b)+0x4000)>>14)

void display_move_point(display_point_t *p, int distance, uint16_t angle)
{
    p->x += DISPLAY_MUL(distance, display_cos(angle)) - distance;
    p->y += DISPLAY_MUL(distance, display_sin(angle)) - distance;
}

#undef DISPLAY_MUL


